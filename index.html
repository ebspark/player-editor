<!DOCTYPE html>
<html>

<head>
    <title>Three.js Project Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>

    <nav class="navbar">
        <div class="dropdown">
            <button class="dropbtn">File</button>
            <div class="dropdown-content">
                <button onclick="handleNew()">New Scene</button>
                <button onclick="handleOpen()">Open Project</button>
                <button onclick="handleSave()">Save Project</button>
                <button onclick="handleExport()">Export Scene</button>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">Add</button>
            <div class="dropdown-content">
                <button onclick="createPlayer()">Create New Player</button>
                <button onclick="addLevel()">Add Level</button>
                <button onclick="addExistingPlayer()">Add Existing Player</button>
                <button onclick="addItem()">Add Item</button>
                <button onclick="openCosmeticUploader()">Upload New Cosmetic</button>
                <button onclick="openBatchUploader()">Upload Batch Cosmetics</button>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">Import</button>
            <div class="dropdown-content">
                <button onclick="document.getElementById('sgm-file-input').click()">Import .sgm</button>
                <input type="file" id="sgm-file-input" accept=".sgm" style="display:none;"
                    onchange="handleFileSelection(event)" />

                <button onclick="document.getElementById('glb-file-input').click()">Import .glb</button>
                <input type="file" id="glb-file-input" accept=".glb" style="display:none;"
                    onchange="handleFileSelection(event)" />

                <button onclick="document.getElementById('obj-file-input').click()">Import .obj</button>
                <input type="file" id="obj-file-input" accept=".obj" style="display:none;"
                    onchange="handleFileSelection(event)" />
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">Settings</button>
            <div class="dropdown-content">
                <div class="dropdown">
                    <button class="dropbtn">Thanks!</button>
                    <div class="dropdown-content">
                        <span>Index</span>
                        <span>Slin</span>
                        <span>Vestria</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn" onclick="somefuntion()">placeholder</button>
        </div>

        <button id="editPlayerBtn" class="dropbtn" style="display: none; background-color: #55aaff;"
            onclick="editSelectedPlayer()">
            ✏️ Edit Player
        </button>
    </nav>

    <div class="tools" id="tools">
        <button onclick="setTransformMode('translate')" id="translateBtn" title="Move">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2v20M12 2l3 3M12 2l-3 3" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M2 12h20M22 12l-3 3M22 12l-3-3" stroke="currentColor" stroke-width="2" fill="none" />
                <circle cx="12" cy="12" r="1" fill="currentColor" />
                <path d="M12 22l3-3M12 22l-3-3" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M2 12l3 3M2 12l3-3" stroke="currentColor" stroke-width="2" fill="none" />
            </svg>
        </button>
        <button onclick="setTransformMode('rotate')" id="rotateBtn" title="Rotate">
            <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="6.18 5.18 11.63 12.63">
                <path
                    d="M15.7733 13.3292C15.4851 14.1471 14.9388 14.8493 14.2169 15.3298C13.4949 15.8103 12.6363 16.0432 11.7704 15.9934C10.9046 15.9436 10.0784 15.6137 9.41631 15.0535C8.75424 14.4933 8.29217 13.7332 8.09972 12.8876C7.90728 12.042 7.99489 11.1567 8.34934 10.3652C8.7038 9.57374 9.3059 8.91887 10.0649 8.4993C10.824 8.07974 11.6988 7.91819 12.5576 8.03902C13.9223 8.23101 14.9173 9.23345 16 10M16 10V7M16 10H13"
                    stroke="currentcolor" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
        <button onclick="setTransformMode('scale')" id="scaleBtn" title="Scale">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 4l4 4M4 4l4-1M4 4l-1 4" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M20 4l-4 4M20 4l-4-1M20 4l1 4" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M4 20l4-4M4 20l4 1M4 20l-1-4" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M20 20l-4-4M20 20l-4 1M20 20l1-4" stroke="currentColor" stroke-width="2" fill="none" />
                <circle cx="12" cy="12" r="1" fill="currentColor" />
            </svg>
        </button>

        <button onclick="deselectObject()" title="Deselect">
            <svg viewBox="0 0 24 24">
                <path d="M21 3L3 21M3 3l18 18" />
            </svg>
        </button>
    </div>

    <div class="stats-panel">
        <h3>Scene Statistics</h3>
        <div class="stat-item">
            <span class="stat-label">Objects:</span>
            <span class="stat-value" id="objectCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Vertices:</span>
            <span class="stat-value" id="vertexCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Faces:</span>
            <span class="stat-value" id="faceCount">0</span>
        </div>
    </div>

    <div class="popup-overlay" id="itemPopup" style="display: none;">
        <div class="popup-content">
            <button class="close-button" onclick="closeItemPopup()">×</button>
            <input type="text" class="search-input" id="itemSearch" placeholder="Search items..."
                oninput="filterItems()">
            <div class="grid-container" id="itemGrid"></div>
        </div>
    </div>

    <div class="popup-overlay" id="createPlayerPopup" style="display: none;">
        <div class="popup-content"
            style="display: flex; gap: 20px; width: 90%; max-width: 1270px; height: 90%; max-height: 720px;">
            <div class="player-editor-panel" style="flex: 1; display: flex; flex-direction: column;">
                <h3>Player Preview</h3>
                <div id="playerPreviewContainer"
                    style="flex-grow: 1; border: 1px solid #444; position: relative; border-radius: 8px; overflow: hidden;">
                </div>
                <div class="player-controls" style="padding-top: 15px;">
                    <h4>Player Colors</h4>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <label for="primaryColor">Primary:</label>
                        <input type="color" id="primaryColor" value="#00ff00">
                        <label for="secondaryColor">Secondary:</label>
                        <input type="color" id="secondaryColor" value="#ff0000">
                    </div>
                    <div class="button-group">
                        <button id="playerDoneButton" class="btn btn-success">Done</button>
                        <button onclick="closeCreatePlayerPopup()" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="item-selection-panel">
                <h3>Equip Items</h3>
                <input type="text" id="playerItemSearch" class="search-input" placeholder="Search items..."
                    oninput="filterPlayerItems()">
                <div id="playerItemGrid">
                    <div class="model-grid-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="attachmentOverlay" class="attachment-overlay">
        <div class="attachment-popup">
            <h2>Attachment Setup</h2>
            <div class="form-group">
                <label>Attachment Type:</label>
                <input type="text" id="attachmentTypeInput" list="attachmentTypesList" class="form-control"
                    placeholder="e.g., head/hat or body/jetpack" oninput="handleAttachmentTypeChange()">

                <datalist id="attachmentTypesList">
                    <option value="head/hat"></option>
                    <option value="head/glasses"></option>
                    <option value="head/glasses/mouth"></option>
                    <option value="body/neck"></option>
                    <option value="body/neck/chest"></option>
                    <option value="body/backpack"></option>
                    <option value="body/badge"></option>
                    <option value="checkpoint"></option>
                    <option value="grapple/hook"></option>
                    <option value="head"></option>
                    <option value="body"></option>
                    <option value="hand"></option>
                </datalist>
            </div>
            <div class="form-group">
                <label>Attachment Point (Optional):</label>
                <input type="text" id="attachmentPointInput" class="form-control"
                    placeholder="e.g., mouth (for head/glasses)" oninput="liveUpdateCustomTypePreview()">
            </div>
            <div id="dualItemSelection" class="form-group" style="display: none; background: #3a3a3a; padding: 10px; border-radius: 6px;">
                <label for="attachmentDualItem" style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="attachmentDualItem" onchange="handleAttachmentTypeChange()" style="width: 20px; height: 20px; margin-right: 10px;">
                    Is this a "Dual Item"? (e.g., Badge)
                </label>
                <p style="font-size: 12px; color: #ccc; margin-top: 5px;">
                    Check this if the item can be equipped to a 'left' OR 'right' slot (like body/badge). Do not check for 'hand' items.
                </p>
            </div>

            <div id="sideSelection" class="form-group" style="display: none;">
                <label>Side:</label>
                <select id="attachmentSide" class="form-control" onchange="handleAttachmentTypeChange()">
                    <option value="none">-- none -- </option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                </select>
            </div>

            <!-- MODIFICATION: Added oninput events to all inputs -->
            <div id="customTypeSetup" class="form-group"
                style="display: none; background: #333; padding: 10px; border-radius: 6px;">
                <label style="color: #55aaff; font-weight: bold;">New Attachment Type Setup (Live Preview)</label>
                <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">A preview mannequin will appear. Tweak
                    values to position the item.</p>

                <label style="font-size: 13px; margin-top: 5px;">Position (X, Y, Z)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="customTypePosX" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                    <input type="number" id="customTypePosY" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                    <input type="number" id="customTypePosZ" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                </div>

                <label style="font-size: 13px; margin-top: 5px;">Rotation (Y, X, Z - Yaw, Pitch, Roll)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="customTypeRotY" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                    <input type="number" id="customTypeRotX" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                    <input type="number" id="customTypeRotZ" class="form-control" value="0"
                        oninput="liveUpdateCustomTypePreview()">
                </div>

                <label style="font-size: 13px; margin-top: 5px;">Scale</label>
                <input type="number" id="customTypeScale" class="form-control" value="1"
                    oninput="liveUpdateCustomTypePreview()">
            </div>
            <!-- END MODIFICATION -->

            <div class="form-group">
                <label>Model Name:</label>
                <input type="text" id="modelName" class="form-control" placeholder="Auto-generated name">
            </div>

            <div class="button-group">
                <button id="uploadButton" class="btn btn-primary">Upload Cosmetic</button>
                <button id="nextButton" class="btn btn-secondary">Next</button>
                <button id="doneButton" class="btn btn-success">Done</button>
            </div>

            <input type="file" id="modelUpload" hidden accept=".sgm" />
        </div>
    </div>

    <div id="attachmentConfigWidget" class="config-widget">
        <div class="section">
            <h3>Attachment Points</h3>
            <div id="attachmentPointsList" class="controls-list"></div>
        </div>

        <div class="section">
            <h3>Overrides</h3>
            <select id="overrideTargetSelect"></select>
            <div id="overrideControls" class="controls-list"></div>
        </div>
    </div>

    <div class="main-container">
        <div id="canvas-container">
            <div id="ae-preview-bar"></div>
        </div>
        <div class="json-panel">
            <div id="json-resize"></div>
            <div class="json-header">JSON Data / Properties</div>

            <div id="json-controls"
                style="padding: 8px 16px; background: #232323; border-bottom: 1px solid #333; display: none;">
                <button id="jsonAttachmentModeToggle" onclick="toggleAttachmentMode()"
                    title="Toggle which attachment config to edit (Key: 5)" class="nav-button"
                    style="width: 100%; display: block; text-align: center; background-color: #333; color: #55ff55; font-weight: bold;">
                    Attachment Point Overrides
                </button>
            </div>

            <div class="json-editor" id="jsonEditor"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@latest/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@6.11.2/dist/protobuf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs/loader.min.js"></script>

    <script src="./monaco-setup.js"></script>
    <script src="./SGALoader.js"></script>
    <script src="./SGMLoader.js"></script>
    <script src="./MeshUtils.js" type="module"></script>
    <script type="module" src="./Player.js"></script>
    <script src="./levelLoader.js"></script>
    <script src="./selection-stuff.js"></script>
    <script src="./script.js"></script>
    <script src="./model-grid-component.js"></script>
    <script src="./js/tools.js"></script>
    <script src="./add-item.js"></script>
    <script type="module" src="./player-creator.js"></script>

</body>

</html>